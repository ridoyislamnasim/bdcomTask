<%- include(`../commonPartial/header.ejs`); %>
    <%- include(`../commonPartial/menu.ejs`); %>
    <section class="home-section">
        <div class="home-content">
        <div class="manageAddRoom-container">
            <div id="title">
                <h2>Manage Create Seat Plan </h2>
            </div>
            <div class="new-seatPlan-container new-room">
                <a href="#" onclick="createSeatPlan()" class="newadd">Create Seat Plan</a>
                <div style="display: flex;"  >
                    <!-- <div class="searchOpen">
                        <a href="#" onclick="SearchOpen()" class="newadd">Search</a>
                    </div> -->
                
                <div class="seatPlan_search_box" style="display: none;">
                    <div style="display: flex;" >
                        <form  style="display: flex;" method="post" action="/login" id="dateSlotSearch">
                            <input class="ExamDate"  type="date" placeholder="Enter Date" name="search_date"  style="margin : 0px 2.5px; padding: 10px 10px; gap: 0;"/>
                            <input class="SlotName" style="margin : 0px 2.5px; padding: 10px 10px;" type="text" placeholder="Enter Solt Name" name="search_solt" />
                            <button type="submit"><a type="submit"  style="margin: 0px 5px;" href="#" onclick="" class="newadd" >Search</a></button> 
                        </form>              
                    
                     <a onclick="SearchCancel()" href="#" onclick="" class="newadd" style="background: linear-gradient(to right, #f7b29c 0%, #f6825e 100%);">Cancel</a>
                    </div>

                </div>
                </div>

            </div>
            <div id="rooms-table">
                <!-- <input type="text" id="searchInput" placeholder="Search"> -->
                <table id="routine-table" >
                    <thead>
                        <tr>
                            <th>Exam Date</th>
                            <th>Slot </th>
                            <th>Room Number</th>
                            <th>Column</th>
                            <th>Subject</th>
                            <th>Level/Term</th>
                            <th>Section</th>
                            <th>Te. Initial</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(var seatPlan_index=0; seatPlan_index < seatPlanInfo.length ; seatPlan_index++){%>
                       
                            <% let higestCol = 0 %>
                            <% for (var i=0; i < seatPlanInfo[seatPlan_index].columnInfo.length ; i++) { %>
                                <% if (seatPlanInfo[seatPlan_index].columnInfo[i]) { %>
                                <% for (var j=0; j < seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo.length ; j++) { %>
                                          <%  higestCol += 1 %>                           
                                   <% } %>
                                <% } %>
                            <% } %>
                            <tr id="">
                                <td rowspan="<%= higestCol  %>" class="date">
                                    <span><% const date = new Date(seatPlanInfo[seatPlan_index].Date); %><span><%= date.toLocaleDateString(undefined, { day: 'numeric', month: 'long', year: 'numeric' })   %> <span>-</span>( <%= date.toLocaleDateString(undefined, { weekday: 'long'}) %> )</span></span>
                                </td>
                                <td rowspan="<%= higestCol %>" class="slot">
                                    <span><%= seatPlanInfo[seatPlan_index].slot %></span>
                                </td>
                                <td rowspan="<%= higestCol %>" class="roomNo">
                                    <span><%= seatPlanInfo[seatPlan_index].roomNumber %> </span>
                                </td>
                                <% for (var i=0; i < seatPlanInfo[seatPlan_index].columnInfo.length ; i++) { %>
                                 
                                    <% if (i==0) { %>
                                     
                                        <% for (var subject_index=0; subject_index < seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo.length ; subject_index++) { %>

                                            <% if (subject_index==0) { %>
                                                <td rowspan="<%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo.length %>" > 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].columnName %></span>
                                                </td>

                                                <td> 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectCode %>: <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectName %></span>
                                                </td>
                                                <td> 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].Level %> / <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].term %></span>
                                                </td>
                                                <td> 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].sectionName %> (<%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].numberOfStudent %>)</span>
                                                </td>
                                                <td> 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].teacherInnitial %></span>
                                                </td>                                              
                                             <% }else{ %>
                                                <tr>
                                                    <td> 
                                                        <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectCode %>: <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectName %></span>
                                                    </td>
                                                    <td> 
                                                        <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].Level %> / <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].term %></span>
                                                    </td>
                                                    <td> 
                                                        <span> <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].sectionName %> (<%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].numberOfStudent %>)</span>
                                                    </td>
                                                    <td> 
                                                        <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].teacherInnitial %></span>
                                                    </td>
                                                </tr>
                                             <% } %>
                                               


                                        <% } %>
                                     <% }else{ %>
                                        <tr>
                                        <td rowspan="
                                        <% if ( seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo.length >0) { %>
                                            <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo.length %><% } %>"> 
                                            <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].columnName %></span>
                                        </td>
                                        <% for (var subject_index=0; subject_index < seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo.length ; subject_index++) { %>
                                            <% if (seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo.length >1) { %>
                                                 <% if (subject_index==0) { %>
                                                    <td> 
                                                        <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectCode %>: <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectName %></span>
                                                    </td>
                                                    <td> 
                                                        <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].Level %> / <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].term %></span>
                                                    </td>
                                                    <td> 
                                                        <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].sectionName %> (<%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].numberOfStudent %>)</span>
                                                    </td>
                                                    <td> 
                                                        <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].teacherInnitial %></span>
                                                    </td>                                              
                                                 <% }else{ %>
                                                    <tr>
                                                        <td> 
                                                            <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectCode %>: <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectName %></span>
                                                        </td>
                                                        <td> 
                                                            <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].Level %> / <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].term %></span>
                                                        </td>
                                                        <td> 
                                                            <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].sectionName %> (<%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].numberOfStudent %>)</span>
                                                        </td>
                                                        <td> 
                                                            <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].teacherInnitial %></span>
                                                        </td>
                                                    </tr>
                                                 <% } %>
                                                   
                                                
                                             
                                            <% }else{ %>
                                                <td> 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectCode %>: <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].subjectName %></span>
                                                </td>
                                                <td> 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].Level %> / <%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].term %></span>
                                                </td>
                                                <td> 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].sectionName %> (<%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].numberOfStudent %>)</span>
                                                </td>
                                                <td> 
                                                    <span><%= seatPlanInfo[seatPlan_index].columnInfo[i].subjectInfo[subject_index].teacherInnitial %></span>
                                                </td>
                                            <% } %>
                                        <% } %>
                                        </tr>
                                     <% } %>
                                   
                                 
                                    
                                <% } %>

                            </tr>
                        
                        
                           
                            <% } %>
                           

                    </tbody>
                </table>

                <div id="pagination"></div>
            </div>
            <div id="search_after_table">

            </div>
        </div>
        </div>
        </section>
        
<script>
// search related
                const  searchOpen =  document.querySelector(".searchOpen")
                const  seatPlan_search_box =  document.querySelector(".seatPlan_search_box")
                const  ExamDate =  document.querySelector(".ExamDate")
                const  SlotName =  document.querySelector(".SlotName")
                const  routine_table =  document.querySelector("#routine-table")
                

                 function SearchOpen(){
                    searchOpen.style.display = "none";
                    seatPlan_search_box.style.display = "block";
                 }
                 function SearchCancel(){
                    searchOpen.style.display = "block";
                    seatPlan_search_box.style.display = "none";
                     // reload the page after 1 second
                        setTimeout(() => {
                        location.reload();
                    }, 100);
                 }
                //  async function SearchStart(){
                    console.log("outer")

                    dateSlotSearch.onsubmit = async function(event){
                        event.preventDefault();

                    console.log("inner")
    // addStuddentForm.onsubmit =async function(event){
    //     event.preventDefault();
                const  dateSlotSearch =  document.querySelector("#dateSlotSearch")
                const  search_after_table =  document.querySelector("#search_after_table")
                    const formData = new FormData(dateSlotSearch);
                    const response = await fetch("/Administrator/Routine/seatPlan/DateAndSlot", {
                             method: "POST",
                             body: formData
                            });
                            let result = await response.json();
                            console.log("--",typeof(result))
                            console.log("--",result)

//

//
               console.log("--",typeof(result))
                if (result === null || result === undefined || result.length === 0) {
               // Array is null, undefined, or empty
                    alert("Not Find Any Data!!!")
                    }else{
                        console.log("search data", result);
                        // routine_table.style.display = "none";

                        //--------------------------------------------------------------------------------------
                    //     setTimeout(() => {
                    //     location.reload();
                    // }, 100);


                        //--------------------------------------------------------------------------------------
                    }
               


                 }
                
                // }


// search related
const createSeatPlanTost = Toastify({
            text: "User was deleted successfully!",
            duration: 3000,
        });

            async function createSeatPlan() {
                let response = await fetch("/Administrator/Routine/createSeatPlan", {
                    method: "post",
                });
                let result = await response.json();
                // alert("result");

                console.log("result", result);

                if (result.message) {
                    // errors
                    alert(result.message);
                    console.log("working go")
                } else {
                    // success
                    console.log("close");
                    // successToast.showToast();
                    createSeatPlanTost.showToast();

                    // closeTeacherModal();
                    // document.querySelector("p.error").style.display = "none";

                    // reload the page after 1 second
                    setTimeout(() => {
                        location.reload();
                    }, 300000);

                }
            } 
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-bootgrid/1.3.1/jquery.bootgrid.min.js"></script>


        <!-- manu open close -->

        <script>
            function convertTableDataToJson() {
  var table = document.getElementById('routine-table');
  var rows = table.getElementsByTagName('tr');
  var jsonData = [];

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    var rowData = {};

    for (var j = 0; j < cells.length; j++) {
      var cell = cells[j];
      var columnName = table.rows[0].cells[j].textContent;
      var cellText = cell.textContent.trim();

      if (cell.getAttribute('rowspan')) {
        var rowspan = parseInt(cell.getAttribute('rowspan'));

        if (!rowData[columnName]) {
          rowData[columnName] = [];
        }

        var rowSpanData = {
          text: cellText,
          rowspan: rowspan
        };

        rowData[columnName].push(rowSpanData);
      } else {
        rowData[columnName] = cellText;
      }
    }

    jsonData.push(rowData);
  }

  return JSON.stringify(jsonData);
}

var tableDataJson = convertTableDataToJson();
console.log(tableDataJson);

        </script>

        <%- include(`../commonPartial/manuOpenCloseScript.ejs`); %>